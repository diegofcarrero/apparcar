{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="container mt-5">
 <div class="container mt-5">
  <!-- Saludo / t√≠tulo de la home -->
  <h2 class="text-center mb-1">üëã Hola, {{ user.username }}</h2>
  <p class="text-center text-muted mb-4">Este es tu panel de usuario</p>
 
  <!-- Bot√≥n para mostrar/ocultar formulario -->
  <div class="text-end mb-3">
    <button id="toggle-form-btn" class="btn btn-success">
      ‚ûï Agregar Veh√≠culo
    </button>
  </div>

  <!-- Formulario oculto inicialmente -->
  <form id="add-vehicle-form" method="POST" action="{% url 'add_vehicle' %}" class="mb-4" style="display: none;">
    {% csrf_token %}
    <div class="row g-2 align-items-end">
      <div class="col-md-2">
        <label class="form-label">Placa</label>
        <input type="text" name="license_plate" class="form-control" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">Tipo</label>
        <select name="vehicle_type" class="form-select">
          <option value="car">Auto</option>
          <option value="moto">Moto</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Marca</label>
        <input type="text" name="brand" class="form-control" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">Modelo</label>
        <input type="text" name="model" class="form-control" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">Color</label>
        <input type="text" name="color" class="form-control" required>
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">Guardar</button>
      </div>
    </div>
  </form>

  <!-- Tabla de veh√≠culos -->
  <table class="table table-striped align-middle text-center">
    <thead class="table-dark">
      <tr>
        <th>Seleccionar</th>
        <th>Placa</th>
        <th>Tipo</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for v in vehicles %}
      <tr>
        <td><input type="radio" name="selected_vehicle" value="{{ v.id }}"></td>
        <td>{{ v.license_plate }}</td>
        <td>{{ v.get_vehicle_type_display }}</td>
        <td>
          <a href="{% url 'edit_vehicle' v.id %}" class="btn btn-warning btn-sm">Editar</a>
          <a href="{% url 'delete_vehicle' v.id %}" class="btn btn-danger btn-sm">Eliminar</a>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="7">No tienes veh√≠culos registrados.</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Bot√≥n de buscar parqueaderos -->
  <div class="text-center mt-4">
    <!-- Bot√≥n de buscar parqueaderos -->
<div class="text-center mt-4">
  <a id="search-btn" href="#" class="btn btn-primary btn-lg disabled" aria-disabled="true">
    üîç Buscar Parqueaderos
  </a>
</div>

<script>
  const radios = document.querySelectorAll('input[name="selected_vehicle"]');
  const searchBtn = document.getElementById('search-btn');

  radios.forEach(radio => {
    radio.addEventListener('change', () => {
      searchBtn.classList.remove('disabled');
      searchBtn.setAttribute('aria-disabled', 'false');

      // Actualiza el enlace con el veh√≠culo seleccionado
      const vehicleId = radio.value;
      searchBtn.href = `{% url 'parking_list_user' %}?vehicle_id=${vehicleId}`;
    });
  });

  // Mostrar/ocultar formulario (mantiene tu funcionalidad anterior)
  const toggleFormBtn = document.getElementById('toggle-form-btn');
  const addForm = document.getElementById('add-vehicle-form');

  toggleFormBtn.addEventListener('click', () => {
    if (addForm.style.display === 'none') {
      addForm.style.display = 'block';
      toggleFormBtn.textContent = '‚úñÔ∏è Cancelar';
      toggleFormBtn.classList.remove('btn-success');
      toggleFormBtn.classList.add('btn-danger');
    } else {
      addForm.style.display = 'none';
      toggleFormBtn.textContent = '‚ûï Agregar Veh√≠culo';
      toggleFormBtn.classList.remove('btn-danger');
      toggleFormBtn.classList.add('btn-success');
    }
  });
</script>

  </div>
    </div>

    <script>
      // Mostrar/ocultar formulario
      const toggleFormBtn = document.getElementById('toggle-form-btn');
      const addForm = document.getElementById('add-vehicle-form');

      toggleFormBtn.addEventListener('click', () => {
        if (addForm.style.display === 'none') {
          addForm.style.display = 'block';
          toggleFormBtn.textContent = '‚úñÔ∏è Cancelar';
          toggleFormBtn.classList.remove('btn-success');
          toggleFormBtn.classList.add('btn-danger');
        } else {
          addForm.style.display = 'none';
          toggleFormBtn.textContent = '‚ûï Agregar Veh√≠culo';
          toggleFormBtn.classList.remove('btn-danger');
          toggleFormBtn.classList.add('btn-success');
        }
      });
    {% if active_sessions %}
    <hr class="my-4">
    <h4 class="text-center mb-3">üÖøÔ∏è Sesiones Activas</h4>
    <div class="table-responsive">
      <table class="table table-bordered align-middle text-center">
        <thead class="table-dark">
          <tr>
            <th>Veh√≠culo</th>
            <th>Parqueadero</th>
            <th>Hora de Entrada</th>
            <th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody>
          {% for session in active_sessions %}
          <tr>
            <td>{{ session.car.license_plate }}</td>
            <td>{{ session.parking.name }}</td>
            <td>{{ session.entry_time|date:"d/m/Y H:i" }}</td>
            <td>
             <td>
              <button type="button" class="btn btn-danger btn-sm" 
                      data-bs-toggle="modal" 
                      data-bs-target="#closeSessionModal{{ session.id }}">
                üõë Finalizar
              </button>

              <!-- Modal -->
              <div class="modal fade" id="closeSessionModal{{ session.id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <p>Total estimado: <strong>$<span id="totalSession{{ session.id }}">0.00</span></strong></p>
                    <div class="modal-header">
                      <h5 class="modal-title">Finalizar Sesi√≥n</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                      <p>Veh√≠culo: <strong>{{ session.car.license_plate }}</strong></p>
                      <p>Parqueadero: <strong>{{ session.parking.name }}</strong></p>
                      <p>Hora de entrada: {{ session.entry_time|date:"d/m/Y H:i" }}</p>
                      {% with total=session.calculate_total %}
                      <p>Total estimado: <strong>${{ total|floatformat:2 }}</strong></p>
                      {% endwith %}
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                      <a href="{% url 'close_user_session' session.id %}" class="btn btn-danger">
                        Confirmar Finalizaci√≥n
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </td>

            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="alert alert-info text-center mt-4">
      No tienes sesiones de parqueo activas.
    </div>
    {% endif %}

  // Activar bot√≥n cuando se selecciona un veh√≠culo
  const radios = document.querySelectorAll('input[name="selected_vehicle"]');
  const searchBtn = document.getElementById('search-btn');

  radios.forEach(radio => {
    radio.addEventListener('change', () => {
      searchBtn.classList.remove('disabled');
      searchBtn.setAttribute('aria-disabled', 'false');
    });
  });
</script>

<script>
  {% for session in sessions %}
  function updateTotal{{ session.id }}() {
    fetch("{% url 'session_total_ajax' session.id %}")
      .then(response => response.json())
      .then(data => {
        document.getElementById("totalSession{{ session.id }}").textContent = data.total.toFixed(2);
      });
  }

  // Actualiza cada 10 segundos
  setInterval(updateTotal{{ session.id }}, 10000);

  // Actualiza tambi√©n cuando se abre el modal
  var modal{{ session.id }} = document.getElementById("closeSessionModal{{ session.id }}");
  modal{{ session.id }}.addEventListener('show.bs.modal', updateTotal{{ session.id }});
  {% endfor %}
</script>


{% endblock %}
