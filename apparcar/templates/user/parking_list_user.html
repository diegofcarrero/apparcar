{% extends 'base.html' %}
{% block title %}Parqueaderos disponibles{% endblock %}

{% block content %}

<div class="container mt-4">

    {% if selected_vehicle %}
        <div class="alert alert-info text-center">
            Veh√≠culo seleccionado: <strong>{{ selected_vehicle.license_plate }}</strong>
            ({{ selected_vehicle.get_vehicle_type_display }})
        </div>
    {% else %}
        <div class="alert alert-warning text-center">
            ‚ö†Ô∏è Debes seleccionar un veh√≠culo antes de estacionar.
        </div>
    {% endif %}

    <h3 class="mb-4">Parqueaderos disponibles</h3>

    <!-- Buscador -->
    <form method="GET" action="{% url 'parking_list_user' %}">
        <div class="input-group mb-3">
            <input type="text" name="q" class="form-control" placeholder="Buscar por nombre o lugar..."
                value="{{ query }}">
            {% if selected_vehicle %}
                <input type="hidden" name="vehicle_id" value="{{ selected_vehicle.id }}">
            {% endif %}
            <button class="btn btn-outline-primary">Buscar</button>
            <a href="{% url 'user_semantic_search' %}" class="btn btn-info">Buscar Parqueaderos con IA üîç</a>
        </div>
    </form>

    <!-- Mapa -->
    <h3 class="text-center mt-5">Mapa de Parqueaderos</h3>
    <div id="map" style="width: 100%; height: 420px;" class="border"></div>

</div>

{% endblock %}

{% block extra_scripts %}

<script>
function initMap() {

    // Centro inicial: Ibagu√© Tolima
    const defaultLocation = { lat: 4.438889, lng: -75.232222 };

    // Crear mapa
    const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 14,
        center: defaultLocation
    });

    // Parse JSON desde Django
    const parkings = JSON.parse('{{ parkings_json|escapejs }}');

    const bounds = new google.maps.LatLngBounds();

    parkings.forEach(p => {
        if (!p.latitude || !p.longitude) return;

        const pos = { lat: p.latitude, lng: p.longitude };

        // Marcador
        const marker = new google.maps.Marker({
            position: pos,
            map: map,
            title: p.name
    });

    // Popup din√°mico
    const popup = new google.maps.InfoWindow({
        content: `
            <b>${p.name}</b><br>
            üöó carros: ${p.car_spaces}<br>
            üèçÔ∏è motos: ${p.moto_spaces}<br>
            üïí Horario: ${p.opening_time} - ${p.closing_time}<br><br>
            {% if selected_vehicle %}
                <a class="btn btn-sm btn-primary"
                    href="{% url 'start_parking_session' 999999 %}?vehicle_id={{ selected_vehicle.id }}"
                    onclick="this.href=this.href.replace('999999', ${p.id})">
                    Estacionar aqu√≠
                </a>
            {% else %}
                <span class="text-muted">Selecciona un veh√≠culo para estacionar</span>
            {% endif %}
        `
    });


        marker.addListener("click", () => popup.open(map, marker));

        bounds.extend(pos);
    });

    // Ajusta mapa si hay marcadores
    if (parkings.length > 0) {
        map.fitBounds(bounds);
    }
}

</script>


<!-- Google Maps con callback -->
<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDrQS2_5FF-Krs_v6U_FpkMKn2zirq2Jgo&callback=initMap">
</script>
<br>
<br>
<br>
<br>
{% endblock %}
